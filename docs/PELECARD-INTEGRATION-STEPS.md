# אינטגרציה עם פלאקארד – הוראת קבע (מנוי חודשי)

מסמך זה מתאר את **הצעדים והזרימה** אם בוחרים לעבוד עם [פלאקארד – סליקת אשראי בהוראת קבע](https://pelecard.com/%d7%a1%d7%9c%d7%99%d7%a7%d7%aa-%d7%90%d7%a9%d7%a8%d7%90%d7%99-%d7%91%d7%94%d7%95%d7%a8%d7%90%d7%95%d7%aa-%d7%a7%d7%91%d7%a2/).

---

## 1. למה פלאקארד מתאימה למנוי חודשי

באתר פלאקארד מופיע שירות **הוראת קבע באשראי** שמתאים בדיוק למנויים:

- **Tokenization** – פרטי הכרטיס נשמרים אצל פלאקארד (תקן PCI-DSS), לא אצלך. אצלך נשמר רק טוקן.
- **חיוב אוטומטי** – המערכת מחייבת במועד שנקבע (למשל כל 1 בחודש) בלי שתצטרך לחייב ידנית.
- **כרטיסים מוחלפים** – אם ללקוח הוחלף כרטיס, פלאקארד מתחברת לממשק כרטיסים מוחלפים ומחייבת את הכרטיס החדש.
- **חשבונית ירוקה** – יש אצלם אינטגרציה להנפקת חשבוניות (רלוונטי לעוסק מורשה).

---

## 1.1 כמה עולה? (עמלות פלאקארד)

**פלאקארד לא מפרסמים באתר מחירון קבוע.** העמלה נקבעת בחוזה לפי סוג העסק, היקף עסקאות והוראת קבע.

- בדרך כלל: **עמלה באחוזים** מכל עסקה (למשל 1.5%–2.5% ויותר) ולפעמים **עמלה קבועה** לעסקה.
- לעסקים קטנים / מחזור נמוך – העמלה לרוב גבוהה יותר מאחוזית מעסק גדול.
- **חובה:** לבקש **הצעת מחיר** מפלאקארד (שיווק: 03-6579500, op@pelecard.co.il) ולוודא במפורש עמלה ל**הוראת קבע** ו־**סליקה ממוחשבת (API)**.

---

## 1.2 האם מוציאים חשבוניות אוטומטית?

**כן.** לפלאקארד יש שירות **[חשבונית ירוקה](https://pelecard.com/חשבוניות-קבלות-ירוקות/)** – הפקה **אוטומטית** של חשבוניות אחרי עסקה (כולל שליחה במייל/קישור ללקוח), בלי הדפסה. מתאים גם לחנות אונליין ומנויים.

- צריך להפעיל אצלם את שירות חשבונית ירוקה ולחבר למערכת הסליקה (לפי ההנחיות שלהם).
- אם אתה עוסק מורשה – לברר בפתיחת החשבון איך מפעילים חשבונית אוטומטית אחרי כל חיוב מנוי.

---

## 2. הצעדים שלך (בלי קוד – מה עושים בשטח)

| # | צעד | איפה / איך |
|---|-----|------------|
| 1 | **הרשמה לעסק** | באתר [pelecard.com](https://pelecard.com) – "צרו קשר" או הרשמה כעסק. חותמים חוזה, מעבירים מסמכים (עוסק/חברה). |
| 2 | **לבקש הפעלת הוראת קבע + API** | בפנייה ל־פלאקארד (שיווק או תמיכה) לציין: "אנחנו צריכים הוראת קבע (מנוי חודשי) ואינטגרציה API לאתר שלנו". |
| 3 | **קבלת פרטי התחברות** | פלאקארד נותנים: **Terminal number**, **User**, **Password** (או מפתח API – לפי מה שהם מספקים). שומרים רק ב־`.env` / משתני סביבה, לא בקוד. |
| 4 | **תיעוד API** | באתר תחת **תמיכה → סליקה API למפתחים** / **מאגר מידע** יש תיעוד למפתחים. חובה להוריד/לקרוא: איך מבצעים עסקה ראשונה (לקבל טוקן), איך מבצעים חיוב חוזר עם טוקן, ומה מחזירים בתשובה. |
| 5 | **חשבוניות** | אם אתה עוסק מורשה – לברר אצלם איך מפעילים "חשבונית ירוקה" או אינטגרציה להנפקת חשבונית אוטומטית אחרי כל חיוב. |

אחרי שיש לך **חשבון פעיל** ו**פרטי API** – אפשר לעבור לשלב הפיתוח.

---

## 3. איך מתממשקים איתו (מבחינה טכנית)

האינטגרציה מתבססת על מה שפלאקארד חושפים ב־**סליקה API למפתחים** (מאגר הידע / תיעוד שהם נותנים). בדרך כלל הזרימה היא אחת מהאפשרויות הבאות:

### אפשרות א': דף תשלום של פלאקארד (הכי נפוץ)

1. **עסקה ראשונה (הרשמה למנוי)**  
   - המשתמש לוחץ "הרשם למנוי" אצלך.  
   - אתה יוצר "עסקת הוראת קבע" דרך ה-API של פלאקארד (לפי התיעוד שלהם).  
   - פלאקארד מחזירים **לינק לדף תשלום** (או **iframe**) – הלקוח מזין שם כרטיס אשראי.  
   - אחרי תשלום מוצלח – פלאקארד מחזירים **טוקן** (מזהה כרטיס מוצפן) + **תוצאה**.  
   - אתה שומר אצלך: `user_id`, `pelecard_token`, `subscription_status = active`, `current_period_end` (למשל +1 חודש).

2. **חיוב חודשי**  
   - פעם בחודש (ב־cron job בשרת, או שירות定时) – עבור כל משתמש עם מנוי פעיל שאצלו `current_period_end` עבר:  
     - קורא ל־API של פלאקארד "חיוב חוזר" עם ה־**טוקן** והסכום.  
   - אם החיוב הצליח – מעדכן `current_period_end` לחודש הבא, ומנפיק חשבונית (אם יש אינטגרציה).  
   - אם נכשל – מעדכן סטטוס ל־"תשלום נכשל", ושולח ללקוח הודעה (אימייל/באפליקציה) להחליף כרטיס.

### אפשרות ב': טופס אםrame / Hosted Page

- פלאקארד מספקים דף תשלום מאובטח (iframe או redirect).  
- אתה שולח ל־API: מזהה עסקה, סכום, קוד חוזר (recurring).  
- הלקוח ממלא כרטיס בדף שלהם.  
- בתום התשלום – פלאקארד מפנים חזרה ל-**Redirect URL** שאתה מגדיר (עם פרמטרים כמו success/failure, token).  
- השרת שלך מקבל את ה־redirect, שומר טוקן ומעדכן מנוי.

**איך "אני יודעת" להתממשק:**  
הקוד עצמו ייכתב לפי **התיעוד הרשמי של פלאקארד** (סליקה API למפתחים + מאגר מידע). אין גישה מכאן לפרטי ה-API המדויקים – את אלה תקבל רק אחרי הרשמה ופתיחת חשבון. ברגע שיהיו בידיך:  
- שמות ה-endpoints (למשל `InitTransaction`, `SubmitPayment`, חיוב חוזר),  
- פרמטרים (Terminal, User, Password, סכום, מטבע, טוקן),  
- תשובות (הצלחה/כישלון, טוקן לכרטיס),

נוכל לכתוב אצלך:  
- **API route** (למשל `POST /api/pelecard/init-subscription`) שיקרא ל־פלאקארד ויחזיר לינק/iframe.  
- **API route** (למשל `GET /api/pelecard/subscription-return`) שיקבל את ה-redirect אחרי תשלום וישמור טוקן + יעדכן מנוי.  
- **Cron / Job** שירוץ כל יום ויחייב משתמשים שהגיע תאריך החידוש שלהם (חיוב חוזר עם הטוקן).

---

## 4. איך זה ייראה אצלך (חוויית משתמש)

| שלב | מה המשתמש רואה |
|-----|-----------------|
| **1. משתמש לא מנוי** | נכנס לאתר/אפליקציה → כשנכנס לאזור שדורש מנוי (למשל "איזור אישי" / יצירת הצעה) → מופיעה לו הודעה: "גישה למנויים בלבד" + כפתור **"הרשם למנוי – 99 ₪/חודש"**. |
| **2. לחיצה על "הרשם למנוי"** | מעבר לדף/מודל "בחירת מנוי" (אם יהיו כמה תוכניות). לוחץ "שלם" → נפתח **דף תשלום מאובטח של פלאקארד** (במסך חדש או iframe) – שם הוא מזין כרטיס אשראי. |
| **3. אחרי תשלום מוצלח** | הפניה חזרה לאתר שלך לדף "תודה – המנוי פעיל", ואפשרות להיכנס לאיזור האישי. |
| **4. כל חודש** | ברקע (בלי שהמשתמש עושה כלום) – השרת מחייב את הכרטיס השמור. אם הצליח – המנוי נשאר פעיל. אם נכשל – המשתמש מקבל הודעה ויכול להזין כרטיס חדש. |
| **5. "המנוי שלי"** | דף בפרופיל: "המנוי פעיל עד תאריך X", "לבטל מנוי" (עצירת חיובים עתידיים אצלך + עדכון סטטוס). |

כלומר: **התשלום בפועל** ייראה בדף של פלאקארד (מאובטח, תקן PCI). **השאר** – כפתורים, הודעות, חסימת גישה, "המנוי שלי" – יישארו בממשק שלך (React/Next.js).

---

## 5. סיכום צעדים להמשך

1. **עכשיו (בלי קוד):**  
   - להירשם אצל פלאקארד כעסק, לבקש הוראת קבע + גישה ל־API.  
   - לקבל פרטי התחברות (Terminal, User, Password / API key).  
   - להוריד/לקרוא את תיעוד **סליקה API למפתחים** (עסקה ראשונה, חיוב חוזר, redirect/iframe).

2. **אחרי שיש תיעוד ופרטי גישה:**  
   - להוסיף טבלת מנויים ב-DB (למשל `subscriptions`: `user_id`, `pelecard_token`, `status`, `current_period_end`).  
   - לבנות: דף "שדרג למנוי" → קריאה ל־API של פלאקארד → הפניה ל־דף תשלום → עמוד return שעדכן מנוי.  
   - לבנות: Job שחייב כל חודש לפי טוקן (חיוב חוזר).  
   - לחסום גישה לאזור האישי למי שאין מנוי פעיל.

3. **אופציונלי:**  
   - דף "המנוי שלי" + ביטול מנוי.  
   - אינטגרציה חשבונית ירוקה (אם רלוונטי).

ברגע שיהיו בידיך **קישור לתיעוד API** או **דוגמת בקשה/תשובה** שפלאקארד נותנים – אפשר לכתוב אצלך את הקריאות המדויקות (endpoints, body, headers) ואת ה-routes ב־Next.js.
